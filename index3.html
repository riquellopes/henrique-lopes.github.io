<!doctype html>
<html lang="pt-BR" prefix="og: http://ogp.me/ns#">
<head>
	<meta charset="utf-8"/>
	<title>Henrique Lopes</title>
	<meta name="author" content="Henrique Lopes">
	<meta name="robots" content="index,follow">
	<meta name="description" content="Tecnologia, Empreendedorismo &amp; LifeStyle">
	<meta name="og:description" content="Tecnologia, Empreendedorismo &amp; LifeStyle">
	<meta property="og:title" content="Henrique Lopes" />
	<meta property="og:url" content="http://blog.henriquelopes.com.br">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="Henrique Lopes"/>
	<meta property="og:locale" content="pt-BR"/>

	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="http://blog.henriquelopes.com.br/theme/css/main.css" type="text/css" />


    <link href="http://blog.henriquelopes.com.br/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Henrique Lopes Atom Feed" />
	<script type='text/javascript' src='//dsms0mj1bbhn4.cloudfront.net/assets/pub/shareaholic.js' data-shr-siteid='b16f727c276b6c965ed2adcc0723a851' data-cfasync='false' async='async'></script>
</head>

<body>

    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="http://blog.henriquelopes.com.br/feeds/all.atom.xml" rel="alternate"><img src="http://blog.henriquelopes.com.br/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
	    </div>
		<a href="http://blog.henriquelopes.com.br" class="title">Henrique Lopes</a>
      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
		  	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
			<br />
			<!-- top-blog-cabecalho -->
			<ins class="adsbygoogle"
			     style="display:inline-block;width:728px;height:90px"
			     data-ad-client="ca-pub-9390117676358866"
			     data-ad-slot="9305902839"></ins>
			<script>
			(adsbygoogle = window.adsbygoogle || []).push({});
			</script>



      <article>
        <h1><a href="http://blog.henriquelopes.com.br/como-criar-uma-api-com-node-js-e-express.html">Como criar uma api com nodejs e express</a></h1>
        <p>Eu sou uma pessoa que gosta de resolver problemas, não criar outros por causa de uma linguagem de programação. O <a href="http://www.desenvolvimentoagil.com.br/scrum/product_owner">PO</a> na maioria das vezes não possui competências técnicas para distinguir qual seria a melhor linguagem ou arquitetura para o seu produto. Você que está entrando no mercado agora ou almeja entrar, deve ter esse tipo sapiência. Você também é parte do processo, software é feito por pessoas, e são elas que tomam as decisões. Por que eu quis iniciar esse post com essa pequena explanação? Eu sou um pythonista de coração, e adoro usar, quando tenho a possibilidade de resolver os problemas pythonicamente, mas no meu dia a dia, eu nem sempre o posso. Hoje na stack que temos no <a href="https://www.hotelurbano.com/">hotelurbano</a>, temos aplicações em <a href="https://www.python.org">python</a>, <a href="https://nodejs.org/en/">nodejs</a>, <a href="http://www.scala-lang.org/">scala</a>, <a href="https://golang.org">go</a>, <a href="https://www.ruby-lang.org/pt/">ruby</a> e <a href="https://secure.php.net/manual/pt_BR/index.php">php</a>. As vezes é necessário desenvolver novas features nessas aplicações, para que elas possam se comunicar com outra aplicação.</p>
<h4>Vamos ao que realmente interessa #nodejs.</h4>
<p>Eu não tive muita dificuldade para entender <a href="https://nodejs.org/en/">nodejs</a>, eu já sabia javascript muito bem, então foi fácil para dar meus primeiros passos. A unica coisa que me atrapalhou um pouco nesse projeto foi montar a minha stack, o <a href="https://nodejs.org/en/">nodejs</a> possui várias implementações para o que eu estava querendo fazer. Mas conversando com amigos mais fluentes em <a href="https://nodejs.org/en/">nodejs</a> eu cheguei ao meu produto, uma api para me informar o valor dos proventos pagos por cada <a href="http://www.fundoimobiliario.com.br/">fundo imobiliário</a>. Se quiser já ir dando uma olhada o <a href="https://github.com/riquellopes/fii">link</a> é esse. Eu vou explicar todo o processo, pode deixar. Vou te dar tudo no esquema.</p>
<p>Eu tentei encontrar alguma api que podesse me fornecer a informação que eu queria, mas não achei nada que fosse de graça. Então acabei criando um <a href="https://pt.wikipedia.org/wiki/Data_scraping">scraping</a>, que raspa essa informação de um outro site. Em python isso é muito tranquilo de se fazer. Com <a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a> e <a href="http://docs.python-requests.org/en/latest/">requests</a>, eu teria isso de forma simples. No <a href="https://nodejs.org/en/">nodejs</a> eu utilizei o <a href="https://www.npmjs.com/package/scrap">scrap</a>, li vários posts que mencionavam ele, então resolvi usar. Para quem já usou jQuery, e sabe um pouco de <a href="https://api.jquery.com/category/selectors/">seletores</a>, não vai encontrar nenhuma dificuldade para utilizar.</p>
<div class="codehilite"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">scrap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">){</span>
    <span class="nx">scrap</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;Serviço indisponível.&quot;</span>
          <span class="k">if</span><span class="p">(</span> <span class="nx">err</span> <span class="p">){</span>
              <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">503</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span><span class="nx">message</span><span class="p">});</span>
          <span class="p">}</span>

          <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">async</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
              <span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
          <span class="p">},</span> <span class="mi">4</span><span class="p">);</span>

          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">,</span><span class="s1">&#39;table&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">tr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">,</span><span class="s1">&#39;table&#39;</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">codigo</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span>
                  <span class="nx">data_base</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span>
                  <span class="nx">cotacao_base</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span>
                  <span class="nx">data_pagamento</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span>
                  <span class="nx">valor_rendimento</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span>
                  <span class="nx">porcentagem_rendimento</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span>
                  <span class="nx">observacao</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nx">tr</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
              <span class="p">}</span>

              <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Fii</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">doc</span><span class="p">){</span>
                  <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
                      <span class="nx">queue</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
                      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span>
                          <span class="p">{</span><span class="nx">message</span><span class="o">:</span><span class="s2">&quot;Erro ao importar as informações.&quot;</span><span class="p">});</span>
                  <span class="p">}</span>
              <span class="p">});</span>
          <span class="p">}</span><span class="c1">// for</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
              <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">503</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span><span class="nx">message</span><span class="p">});</span>
          <span class="p">}</span>

          <span class="nx">queue</span><span class="p">.</span><span class="nx">drain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
                  <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span>
                      <span class="s2">&quot;%s fii, foram copiados.&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))});</span>
          <span class="p">};</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>


<p>Para acelerar um pouco mais o processo, eu utilizei um queue do módulo, <a href="https://github.com/caolan/async">async</a>. Eu não tinha tanta necessidade de fazer isso, mais como era um protótipo, resolvi adicionar essa fila, para que o meu processo fosse mais performático ainda. O módulo <a href="https://github.com/caolan/async">async</a> possui várias features legais, da uma olhada depois na documentação do projeto.</p>
<h4>Orm utilizado.</h4>
<p>Para persistir esses dados, que não possuem uma estrutura muito bem definida eu resolvi utilizar o <a href="https://www.mongodb.org/">mongodb</a>+<a href="https://mongolab.com/">mongolab</a>+<a href="http://mongoosejs.com/">mongoose</a>.
Nas pesquisas que fiz o <a href="http://mongoosejs.com/">mongoose</a> é muito difundido, então segui essa mesma linha. O <a href="https://mongolab.com/">mongolab</a> é um MongoDB-as-a-Service que eu gosto muito, e como eu não queria pagar nada para ter uma máquina com <a href="https://www.mongodb.org/">mongodb</a>, adicionei mais esse ingrediente a minha stack.</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">FiiSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">codigo</span><span class="o">:</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">index</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">unique</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
    <span class="nx">data_base</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">cotacao_base</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">data_pagamento</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">valor_rendimento</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">porcentagem_rendimento</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">baixa_liquides</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span>
    <span class="nx">investidor_qualificado</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span>
    <span class="nx">observacao</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">created</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
        <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">fii</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Fii&#39;</span><span class="p">,</span> <span class="nx">FiiSchema</span><span class="p">);</span>

<span class="nx">FiiSchema</span><span class="p">.</span><span class="nx">pre</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">investidor_qualificado</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">codigo</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;*IQ*&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">baixa_liquides</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">codigo</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;*BL*&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">codigo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">codigo</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">next</span><span class="p">();</span>
<span class="p">})</span>
</pre></div>


<p>Você pode perceber que utilizei um feature do mongoose, <a href="http://mongoosejs.com/docs/middleware.html">pre save</a>, pois antes que ele persiste a informação, eu precisava que algumas coisas fossem extraidas. Pra quem já usou o <a href="https://www.djangoproject.com">django</a> alguma vez, já deve ter esbarrado com <a href="https://docs.djangoproject.com/en/1.9/ref/signals/">signals</a>.</p>
<h4>Aplicação sem test não tem graça.</h4>
<p>Uma das coisas que mais me auxiliam a criar aplicações, sem ter medo de errar, é sempre ter testes para
garantir que minha aplicacação vai fazer exatamente aquilo para qual ela foi criada. Para minha stack de teste eu utilizei,
<a href="https://www.npmjs.com/package/supertest">supertest</a>+<a href="https://www.npmjs.com/package/assert">assert</a>+<a href="https://www.npmjs.com/package/nock">nock</a>+<a href="https://github.com/mochajs/mocha">mocha</a>.</p>
<div class="codehilite"><pre><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;SCRAP&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">before</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">Fii</span><span class="p">.</span><span class="nx">remove</span><span class="p">({},</span> <span class="kd">function</span><span class="p">(){});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should return {message:&#39;94 fii, foram copiados.&#39;}.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
        <span class="nx">nock</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="nx">once</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">,</span> <span class="nx">cb</span><span class="p">){</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&quot;/index.html&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/scrap&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span> <span class="nx">error</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;94 fii, foram copiados.&quot;</span><span class="p">);</span>
                <span class="nx">done</span><span class="p">();</span>
            <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;fii service return 404, scrap service should return message and status 503.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
        <span class="nx">nock</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="nx">once</span><span class="p">().</span><span class="nx">reply</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Fora&quot;</span><span class="p">);</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/scrap&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">503</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;Serviço indisponível.&quot;</span><span class="p">);</span>
                <span class="nx">done</span><span class="p">();</span>
            <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;case html broken, scrap service should return status 503&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
        <span class="nx">nock</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="nx">once</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">,</span> <span class="nx">cb</span><span class="p">){</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&quot;/error.html&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/scrap&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">503</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;Serviço indisponível.&quot;</span><span class="p">);</span>
                <span class="nx">done</span><span class="p">();</span>
            <span class="p">});</span>
    <span class="p">})</span>
<span class="p">});</span>
</pre></div>


<p>O <a href="https://www.npmjs.com/package/nock">nock</a> só é necessário se você precisa <a href="https://pt.wikipedia.org/wiki/Objeto_Mock">mockar</a> alguma resposta.
Para testes que dependem de recursos externernos a sua aplicação, é interessante você <a href="https://pt.wikipedia.org/wiki/Objeto_Mock">mockar</a>, para performar o tempo de resposta do seus testes.
Os testes foram escritos em <a href="https://pt.wikipedia.org/wiki/Behavior_Driven_Development">BDD</a> utilizando o framework <a href="https://github.com/mochajs/mocha">mocha</a>, e para simular as chamadas ao serviço <a href="https://www.npmjs.com/package/supertest">supertest</a>. Para executar a stack de teste é bem simples.</p>
<div class="codehilite"><pre>make <span class="nb">test</span>
or
npm <span class="nb">test</span>
</pre></div>


<h4>Desenvolvendo em ambientes seguros.</h4>
<p>O último módulo é não menos importante que completou a minha stack, foi o <a href="https://www.npmjs.com/package/dotenv">dotenv</a>. Um site que eu indico para você ler, e ter uma melhor noção de boas práticas de software-as-a-service é <a href="http://12factor.net">The Twelve-Factor APP</a>. O tópico que ratifica
o uso desse módulo é o <a href="http://12factor.net/config">III Config</a>. O <a href="https://www.npmjs.com/package/dotenv">dotenv</a> permite que você crie enviroments com as configurações que você precisa no seu ambiente local. Ele não é para ser utilizado em produção. Por default ele vai procurar na raiz
do seu projeto a variável de ambiente <strong>.env</strong>, caso você queira usar outro nome, você precisa passar o <a href="https://www.npmjs.com/package/dotenv#path">path</a> para <a href="https://www.npmjs.com/package/dotenv">dotenv</a>, não é nenhum bicho de 7 cabeças.</p>
<h4>Express em ação.</h4>
<p>Criar uma aplicação com <a href="http://expressjs.com/">express</a> é bem simples, ele não foge muito do
modelo que o <a href="http://flask.pocoo.org/">flask</a> nos da. Eu queria que o meu app, ficasse isolado
do contexto geral, e que de certa forma eu pudesse desplugar ele rapidamente da minha app. Então
eu usei a feature <em>express.Router()</em> para me permitir fazer isso.</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./config&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./models/api.js&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">5000</span><span class="p">;</span>
<span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">()</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">list</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s2">&quot;/scrap&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">scrap</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s2">&quot;/:codigo&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">filter</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;json spaces&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;/api&quot;</span><span class="p">,</span> <span class="nx">router</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">){</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span><span class="s2">&quot;Recupera informações sobre proventos dos fii&quot;</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</pre></div>


<p>Para executar app, basta executar o commando abaixo.</p>
<div class="codehilite"><pre>make run
</pre></div>


<h4>Conclusão.</h4>
<p>Espero que tenha atendido as suas expectativas. Dúvidas ou sugestões é só comentar no post, que eu
estou sempre a disposição para ajudar. Não fique acanhado em fazer um <a href="https://help.github.com/articles/fork-a-repo/">fork</a> e me mandar um <a href="https://help.github.com/articles/using-pull-requests/">pull request</a> com uma melhoria no app.</p>
      </article>

      <hr />

        <div>
          <h3>Last posts</h3>
          <ol class="archive">
    


      <li>
<a href="http://blog.henriquelopes.com.br/a-leitura-e-meus-objetivos.html" rel="bookmark" title="Permalink to A leitura e meus objetivos">A leitura e meus objetivos</a>
  <time datetime="2016-01-25T09:25:00-02:00" pubdate>Mon 25 January 2016</time>
<p class="tags">tags:   <a href="http://blog.henriquelopes.com.br/tag/empreendedorismo.html">empreendedorismo</a> , <a href="http://blog.henriquelopes.com.br/tag/vida.html">vida</a></p></a>      </li>


      <li>
<a href="http://blog.henriquelopes.com.br/como-testar-a-velocidade-da-sua-internet-com-python.html" rel="bookmark" title="Permalink to Como testar a velocidade da sua internet com Python">Como testar a velocidade da sua internet com Python</a>
  <time datetime="2016-01-21T09:00:00-02:00" pubdate>Thu 21 January 2016</time>
<p class="tags">tags:   <a href="http://blog.henriquelopes.com.br/tag/python.html">python</a> , <a href="http://blog.henriquelopes.com.br/tag/ferramenta.html">ferramenta</a></p></a>      </li>


      <li>
<a href="http://blog.henriquelopes.com.br/como-fazer-seu-primeiro-deploy-no-heroku.html" rel="bookmark" title="Permalink to Como fazer seu primeiro deploy no Heroku">Como fazer seu primeiro deploy no Heroku</a>
  <time datetime="2016-01-17T17:48:00-02:00" pubdate>Sun 17 January 2016</time>
<p class="tags">tags:   <a href="http://blog.henriquelopes.com.br/tag/flask.html">flask</a> , <a href="http://blog.henriquelopes.com.br/tag/python.html">python</a> , <a href="http://blog.henriquelopes.com.br/tag/heroku.html">heroku</a> , <a href="http://blog.henriquelopes.com.br/tag/deploy.html">deploy</a></p></a>      </li>


      <li>
<a href="http://blog.henriquelopes.com.br/simples-flask-app.html" rel="bookmark" title="Permalink to Simples Flask App">Simples Flask App</a>
  <time datetime="2016-01-11T21:57:00-02:00" pubdate>Mon 11 January 2016</time>
<p class="tags">tags:   <a href="http://blog.henriquelopes.com.br/tag/python.html">python</a> , <a href="http://blog.henriquelopes.com.br/tag/flask.html">flask</a> , <a href="http://blog.henriquelopes.com.br/tag/dev.html">dev</a></p></a>      </li>


      <li>
<a href="http://blog.henriquelopes.com.br/a-vida-e-a-roda-gigante.html" rel="bookmark" title="Permalink to A vida e a roda gigante">A vida e a roda gigante</a>
  <time datetime="2016-01-10T15:43:00-02:00" pubdate>Sun 10 January 2016</time>
<p class="tags">tags:   <a href="http://blog.henriquelopes.com.br/tag/empreendedorismo.html">empreendedorismo</a></p></a>      </li>




          </ol>
        </div>

		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Categories</h2>
	          <ul>
	              <li ><a href="http://blog.henriquelopes.com.br/category/dev.html">Dev</a></li>
	              <li ><a href="http://blog.henriquelopes.com.br/category/vida.html">Vida</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="http://github.com/riquellopes">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/riquellopes">linkedIn</a><i></i></li>
				  <li><a href="https://twitter.com/riquellopes">twitter</a><i></i></li>
				  <li><a href="https://delicious.com/riquellopes">delicious</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Blogroll</h2>
	            <ul>
	                <li><a href="http://getpelican.com/">Pelican</a></li>
	                <li><a href="http://wiki.python.org.br/">PythonBrasil</a></li>
	            </ul>
	          </aside>

		  </div>

	  </div>

      <footer>
		<p role="contentinfo">
		  © 2016 Henrique Lopes - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
    	</p>

	  </footer>

	</div>

	  <script>
		var _gaq=[['_setAccount','UA-72238128-1'],['_trackPageview']];
		(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
		g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
		s.parentNode.insertBefore(g,s)}(document,'script'));
	  </script>

</body>
</html>